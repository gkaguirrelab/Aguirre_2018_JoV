%% Atchison 2006 Figure 6


atchisonData = [-12.387878787878787, 26.650224215246638
-12.024242424242424, 26.38340807174888
-10.012121212121212, 26.93273542600897
-9.018181818181816, 26.901345291479824
-8.242424242424242, 26.446188340807176
-7.515151515151514, 27.136771300448434
-7.636363636363635, 26.697309417040362
-6.375757575757573, 27.08968609865471
-6.254545454545452, 26.477578475336326
-5.381818181818181, 26.41479820627803
-5.503030303030302, 25.94394618834081
-6.375757575757573, 25.739910313901348
-7.248484848484847, 25.834080717488792
-8.363636363636363, 25.598654708520183
-7.248484848484847, 25.488789237668165
-7.757575757575756, 24.89237668161435
-6.618181818181817, 25.488789237668165
-6.133333333333333, 25.567264573991032
-5.7454545454545425, 25.55156950672646
-4.993939393939392, 25.598654708520183
-5.624242424242423, 25.143497757847534
-6.375757575757573, 24.970852017937222
-5.890909090909091, 24.89237668161435
-5.018181818181816, 24.390134529147986
-4.75151515151515, 25.39461883408072
-4.509090909090906, 25.410313901345294
-4.387878787878787, 25.26905829596413
-4.387878787878787, 25.112107623318387
-4, 25.378923766816147
-4.121212121212119, 24.625560538116595
-4.484848484848484, 24.34304932735426
-4.630303030303029, 24.29596412556054
-3.878787878787877, 24.421524663677133
-4.630303030303029, 22.25560538116592
-3.515151515151514, 23.82511210762332
-3.127272727272725, 25.488789237668165
-2.9818181818181806, 25.426008968609867
-3.2484848484848463, 25.26905829596413
-3.2484848484848463, 24.89237668161435
-3.006060606060604, 24.923766816143498
-3.369696969696969, 24.656950672645742
-3.127272727272725, 24.311659192825115
-3.006060606060604, 24.45291479820628
-2.7636363636363637, 24.40582959641256
-2.7636363636363637, 24.201793721973097
-1.2363636363636346, 25.614349775784756
-1.8666666666666654, 25.488789237668165
-1.9878787878787847, 25.488789237668165
-2.254545454545454, 25.378923766816147
-2.133333333333333, 25.347533632286996
-2.6181818181818155, 25.017937219730943
-2.6181818181818155, 24.64125560538117
-2.4969696969696944, 24.64125560538117
-2.254545454545454, 24.60986547085202
-2.4969696969696944, 24.390134529147986
-2.254545454545454, 24.358744394618835
-2.254545454545454, 24.280269058295968
-2.4969696969696944, 24.076233183856505
-2.375757575757575, 23.74663677130045
-1.9878787878787847, 23.54260089686099
-1.7454545454545443, 23.49551569506727
-1.9878787878787847, 23.93497757847534
-1.503030303030302, 23.369955156950674
-1.260606060606058, 23.244394618834082
-0.9939393939393923, 23.16591928251121
-0.9939393939393923, 23.134529147982065
-0.7515151515151501, 22.977578475336323
-1.6242424242424232, 25.31614349775785
-1.6242424242424232, 24.876681614349778
-1.1151515151515135, 25.00224215246637
-1.1151515151515135, 24.970852017937222
-1.3818181818181792, 24.829596412556057
-0.6060606060606037, 24.93946188340807
1.7763568394002505e-15, 24.970852017937222
-0.8727272727272712, 24.68834080717489
-1.1151515151515135, 24.484304932735427
-1.3818181818181792, 24.40582959641256
-1.503030303030302, 24.57847533632287
-0.9939393939393923, 24.37443946188341
-1.3818181818181792, 24.233183856502244
-1.503030303030302, 24.17040358744395
-1.2363636363636346, 24.123318385650226
-1.2363636363636346, 24.09192825112108
-1.260606060606058, 23.966367713004487
-1.503030303030302, 23.966367713004487
-0.9939393939393923, 23.90358744394619
-0.9939393939393923, 23.558295964125563
-0.5090909090909079, 23.275784753363233
-0.3878787878787868, 23.417040358744398
-0.5090909090909079, 23.558295964125563
-0.5090909090909079, 23.66816143497758
-0.36363636363636154, 23.840807174887892
-0.09696969696969582, 23.558295964125563
-0.2424242424242422, 23.417040358744398
0.24242424242424399, 23.715246636771305
0.36363636363636687, 23.683856502242154
0.2181818181818187, 23.621076233183857
-0.024242424242421734, 23.47982062780269
0.12121212121212288, 23.417040358744398
0.24242424242424399, 23.369955156950674
0.2666666666666675, 23.46412556053812
-0.12121212121211933, 24.123318385650226
-0.26666666666666394, 24.154708520179376
-0.26666666666666394, 24.201793721973097
-0.12121212121211933, 24.233183856502244
0.2666666666666675, 24.29596412556054
0.5090909090909115, 24.123318385650226
0.12121212121212288, 24.672645739910315
0.2666666666666675, 22.9932735426009
0.12121212121212288, 22.695067264573993
0.6303030303030326, 22.930493273542602
-0.12121212121211933, 21.76905829596413
0.24242424242424399, 21.86322869955157
0.7515151515151537, 21.847533632286996]';

[res_refractionCounts,edges] = histcounts(atchisonData(1,:));
res_refractionVals = edges(1:end-1)+(diff(edges))./2;
refractionHistFit = fit(res_refractionVals',res_refractionCounts','gauss1');
sigmaRefractionDiopters  = refractionHistFit.c1;


[res_axialLengthCounts,edges] = histcounts(atchisonData(2,:));
res_axialLengthVals = edges(1:end-1)+(diff(edges)./2);
axialLengthHistFit = fit(res_axialLengthVals',res_axialLengthCounts','gauss1');
sigmaLengthMm = axialLengthHistFit.c1;

p = corrcoef(atchisonData(1,:),atchisonData(2,:));
p = p(1,2);


% Calculate the width of the distribution of axial lengths given the
% spherical refraction. This draws upon the conditional expectation of a
% X given Y in a bivariate normal distribution
conditionalSigmaLength = sqrt((1-p^2)*sigmaLengthMm);


%% Make a figure
h=figure;
set(h, 'Position', [100, 100, 500, 500]);  

countRange = [0 50];
axialLengthRange = [20 30];
refractiveErrorRange = [-14 2];

sh=subplot(2,2,1);
ph=plot(refractiveErrorRange(1):0.01:refractiveErrorRange(2),refractionHistFit(refractiveErrorRange(1):0.01:refractiveErrorRange(2)),'-r');
hold on
plot(res_refractionVals,res_refractionCounts,'ok');
xlim(refractiveErrorRange);
ylim(countRange);
ylabel('counts')
xlabel('spherical refractive error [diopters]')
pbaspect([1 .25 1])

subplot(2,2,4)
plot(axialLengthHistFit(axialLengthRange(1):0.01:axialLengthRange(2)),axialLengthRange(1):0.01:axialLengthRange(2),'-r');
hold on
plot(res_axialLengthCounts,res_axialLengthVals,'ok');
ylim(axialLengthRange);
xlim(countRange);
xlabel('counts')
ylabel('axial length [mm]')
pbaspect([.25 1 1])

% Plot the bivariate normal distribution
D = diag([refractionHistFit.c1 axialLengthHistFit.c1]);
covMatrix = D*[1.0 p; p 1.0]*D;
S = D*[1.0 p; p 1.0]*D;
c = [refractionHistFit.c1 axialLengthHistFit.c1];

subplot(2,2,3)
plot_gaussian_ellipsoid([refractionHistFit.b1 axialLengthHistFit.b1], S, diag(c))
hold on
plot_gaussian_ellipsoid([refractionHistFit.b1 axialLengthHistFit.b1], S, diag(c)*2)
xlim(refractiveErrorRange);
ylim(axialLengthRange);
axis square

% Add the data points
plot(atchisonData(1,:),atchisonData(2,:),'ok');

% Add the behavior of our model
ametropias = refractiveErrorRange(1):1:refractiveErrorRange(2);
clear axialLength
for aa = 1:length(ametropias)
    eye = modelEyeParameters('sphericalAmetropia',ametropias(aa));
    axialLength(aa) = eye.axialLength;
end

plot(ametropias,axialLength,'-k')

atchEq19 = @(x) 23.58 - 0.299 .*x;
plot(ametropias,atchEq19(ametropias),':k');